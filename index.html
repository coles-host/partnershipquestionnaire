<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HostGenius Preferred Partnerships Questionnaire</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap">
    
    <style>
        :root {
            --primary-color: #2e7d32; /* Rich Green */
            --primary-dark: #1b5e20;
            --secondary-color: #f7f9fc; /* Off-white background */
            --card-bg: #ffffff;
            --text-color: #1a202c; /* Dark text */
            --border-color: #e2e8f0;
            --error-color: #e53e3e;
            --success-color: #38a169;
            --admin-color: #3182ce; /* Professional Blue */
            --shadow-light: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            background-color: var(--card-bg);
            box-shadow: var(--shadow-light);
            padding: 18px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h1 {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--primary-color);
            margin: 0;
        }
        
        header h1 span {
            color: #4a5568;
            font-weight: 500;
            font-size: 1.1rem;
            margin-left: 10px;
        }

        main {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            margin-top: 30px;
            margin-bottom: 50px;
        }

        #questionnaire-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
        }

        /* --- Progress Bar --- */
        #progress-container {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #progress-bar {
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #68b36a, var(--primary-color));
            transition: width 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth easing */
        }

        #step-info {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            text-align: right;
        }

        /* --- Form Elements --- */
        h2 {
            color: var(--primary-dark);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 25px;
            border-left: 4px solid var(--primary-color);
            padding-left: 15px;
            line-height: 1.2;
        }
        
        .step-content {
            display: none;
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.5s, transform 0.5s;
        }

        .step-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input[type="text"], input[type="email"], textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
            font-family: 'Inter', sans-serif;
            background-color: #fafafa;
        }

        input[type="text"]:focus, input[type="email"]:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            background-color: var(--card-bg);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* Checkbox Group Styling (Step 2) - Card Look */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-light);
        }

        .checkbox-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .checkbox-item input[type="checkbox"] {
            margin-right: 15px;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #999;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }
        
        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .checkbox-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--card-bg);
            font-size: 14px;
            font-weight: 700;
        }
        
        .checkbox-item input[type="checkbox"]:checked + span {
             font-weight: 600;
             color: var(--primary-dark);
        }
        
        .checkbox-item span {
            font-size: 1rem;
            line-height: 1.4;
        }

        /* Summary Step Styling */
        #summary-content {
            border: 2px solid var(--primary-color);
            padding: 25px;
            border-radius: 10px;
            background-color: #f0fff4; /* Very light green for contrast */
        }

        .summary-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--primary-color);
        }

        .summary-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .summary-section h3 {
            color: var(--primary-dark);
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .summary-section h3::before {
            content: '★';
            color: #f6ad55; /* Gold star */
            margin-right: 8px;
            font-weight: bold;
        }

        .summary-answer {
            margin-bottom: 15px;
            padding-left: 5px;
        }

        .summary-question {
            font-weight: 600;
            color: #4a5568;
            display: block;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .summary-value {
            font-weight: 400;
            display: block;
            white-space: pre-wrap;
            word-break: break-word;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: 6px;
            border: 1px solid #edf2f7;
        }

        /* --- Navigation & Buttons --- */
        #navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 15px;
        }

        button {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
            box-shadow: var(--shadow-light);
            text-transform: uppercase;
        }

        .primary-btn {
            background-color: var(--primary-color);
            color: #fff;
        }

        .primary-btn:hover:not(.disabled-btn) {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 10px rgba(46, 125, 50, 0.4);
            transform: translateY(-1px);
        }

        .secondary-btn {
            background-color: #edf2f7;
            color: var(--text-color);
            border: 1px solid #cbd5e0;
        }

        .secondary-btn:hover:not(.disabled-btn) {
            background-color: #e2e8f0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(10%);
        }
        
        #admin-btn {
            background-color: var(--admin-color);
            color: #fff;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        #admin-btn:hover {
            background-color: #2b6cb0;
        }


        /* --- Messages and Errors --- */
        .error-message {
            color: var(--error-color);
            background-color: #fff5f5;
            border-left: 4px solid var(--error-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-weight: 500;
            display: none;
        }

        .success-message {
            color: var(--success-color);
            background-color: #f0fff4;
            border-left: 4px solid var(--success-color);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            font-weight: 500;
            display: none;
        }

        /* --- Modal Styling --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none; 
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 35px;
            border-radius: 12px;
            width: 95%;
            max-width: 550px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.35);
            position: relative;
            animation: modalSlide 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-height: 90vh; 
            overflow-y: auto;
        }
        
        .modal-large {
            max-width: 1000px;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(-100px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
            padding-bottom: 10px;
        }
        
        .modal-header h3 {
             margin: 0;
             font-size: 1.6rem;
             font-weight: 700;
             color: var(--primary-dark);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #a0aec0;
            padding: 5px;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--error-color);
        }
        
        /* Admin Table Styling */
        #submissions-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            margin-top: 20px;
        }

        #submissions-table th, #submissions-table td {
            padding: 12px 15px;
            text-align: left;
            font-size: 0.9rem;
        }

        #submissions-table thead th {
            background-color: #f7fafc;
            font-weight: 700;
            color: #4a5568;
            border-bottom: 2px solid var(--border-color);
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        
        #submissions-table tbody tr {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow-light);
            transition: transform 0.1s;
        }

        #submissions-table tbody tr:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        #submissions-table .view-answers-btn {
            padding: 8px 12px;
            background-color: var(--admin-color);
            color: #fff;
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 6px;
        }
        
        /* View Submission Modal Detail Overrides */
        #view-submission-details .summary-section {
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        #view-submission-details .summary-question {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        #view-submission-details .summary-value {
            font-size: 1rem;
            background-color: #f9fbfd;
            border: 1px solid var(--border-color);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            main {
                padding: 10px;
                margin-top: 15px;
            }
            #questionnaire-container {
                padding: 20px;
            }
            h2 {
                font-size: 1.6rem;
                padding-left: 10px;
                margin-bottom: 20px;
            }
            #navigation-buttons {
                flex-direction: column;
            }
            button {
                width: 100%;
                min-width: unset;
                margin-top: 10px;
            }
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <header>
        <h1>HostGenius <span>| Partnership Questionnaire</span></h1>
        <button id="admin-btn" class="primary-btn">Admin Dashboard</button>
    </header>

    <main>
        <div id="questionnaire-container">
            <div id="progress-container">
                <div id="progress-bar">
                    <div id="progress-fill"></div>
                </div>
                <div id="step-info">Step 1 of N</div>
            </div>

            <form id="multi-step-form">
                <div id="steps-container">
                    <!-- Steps will be dynamically injected here -->
                </div>

                <div id="validation-error" class="error-message"></div>

                <div id="navigation-buttons">
                    <button type="button" id="back-btn" class="secondary-btn" style="display: none;">← Back</button>
                    <button type="button" id="next-btn" class="primary-btn">Next Step →</button>
                </div>
            </form>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: var(--success-color);">Submission Confirmed!</h3>
                <button class="close-btn" onclick="document.getElementById('success-modal').style.display='none'">&times;</button>
            </div>
            <p style="font-size: 1.1rem; line-height: 1.6;">Thank you for completing the **HostGenius Preferred Partnerships Questionnaire**.</p>
            <p>Your detailed responses have been received. We will be in touch shortly to discuss the opportunities in your selected partnership areas.</p>
            <button class="primary-btn" onclick="window.location.reload();" style="width: 100%; margin-top: 25px;">Start a New Submission</button>
        </div>
    </div>
    
    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Admin Login</h3>
                <button class="close-btn" onclick="document.getElementById('admin-login-modal').style.display='none'">&times;</button>
            </div>
            <div class="form-group">
                <label for="admin-password">Admin Password:</label>
                <input type="password" id="admin-password" required>
            </div>
            <div id="admin-login-error" class="error-message"></div>
            <button id="admin-login-btn" class="primary-btn" style="width: 100%;">Login</button>
        </div>
    </div>
    
    <!-- Admin Panel Modal -->
    <div id="admin-panel-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 style="color: var(--admin-color);">Admin Panel - Submissions</h3>
                <button class="close-btn" onclick="document.getElementById('admin-panel-modal').style.display='none'">&times;</button>
            </div>
            <p id="loading-submissions" style="text-align: center; padding: 20px;">Loading submissions...</p>
            <table id="submissions-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Company</th>
                        <th>Name</th>
                        <th>Services Selected</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="submissions-table-body">
                    <!-- Data rows injected here -->
                </tbody>
            </table>
            <div id="admin-load-error" class="error-message" style="display:none;">Error loading data. Check console.</div>
        </div>
    </div>
    
    <!-- View Submission Detail Modal -->
    <div id="view-submission-modal" class="modal">
        <div class="modal-content modal-large" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Submission Details</h3>
                <button class="close-btn" onclick="document.getElementById('view-submission-modal').style.display='none'">&times;</button>
            </div>
            <div id="view-submission-details">
                <!-- Submission details injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Modular Imports (Updated to latest v11.6.1) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            setLogLevel,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // Global Configuration Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hg_partnership_app_v1';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "MOCK_API_KEY", 
            authDomain: "mock-project.firebaseapp.com",
            projectId: "mock-project",
            storageBucket: "mock-project.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:abcdef1234567890",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        // Hardcoded Admin Password
        const ADMIN_PASSWORD = 'HostGenius123';
        
        // Firestore Path
        const FIRESTORE_COLLECTION_PATH = `artifacts/${appId}/public/data/partnerships_submissions`;

        // 1. Services List
        const servicesList = [
            { id: 'Bookkeeping', label: 'Bookkeeping Services' },
            { id: 'FractionalCFO', label: 'Fractional CFO Services (accounting+bookkeeping - min. Property count: 70)' },
            { id: 'SocialMediaMarketing', label: 'Social Media Marketing Management' },
            { id: 'CanMonkey', label: 'CanMonkey Can-to-Curb Trash Management' },
            { id: 'HRPayroll', label: 'HR+Payroll or Full PEO' },
            { id: 'OutboundSales', label: 'Outbound Homeowner Sales' },
            { id: 'PortfolioAcquisitions', label: 'Portfolio Acquisitions' },
            { id: 'SuiteOp', label: 'SuiteOp (Guest Exp. + Operations + Smart Devices)' },
            { id: 'TopKey', label: 'TopKey Financial Automation+Tracking' },
            { id: 'Conduit', label: 'Conduit (AI Guest messaging)' },
            { id: 'GuestSupport247', label: '24/7 Live Guest Support' },
            { id: 'RevenueManagement', label: 'Revenue Management' }
        ];

        // 2. Full Questionnaire Sections
        const questionnaireSections = {
            'Bookkeeping': {
                title: 'Bookkeeping',
                questions: [
                    'Who is currently handling your bookkeeping?',
                    'What software do you use for bookkeeping?',
                    'Are your books currently up-to-date?',
                    'How many bank accounts and credit cards need reconciling each month?',
                    'How many STR entities do you operate?',
                    'How many owner statements do you prepare each month?',
                    'What is your biggest bookkeeping frustration today?',
                    'What do you currently spend per month on bookkeeping services?', 
                    'Do you want monthly financial statements prepared for you?', 
                    'Do you need cleanup work or catch-up bookkeeping right now?', 
                    'How many doors would you move to a bookkeeping solution immediately?', 
                    'What is the most you would you pay per door per month for this service?' 
                ]
            },
            'FractionalCFO': {
                title: 'Fractional CFO',
                questions: [
                    'How are you currently handling bookkeeping, accounting, and financial oversight?',
                    'What software(s) do you use today?',
                    'How many bank accounts or credit cards need reconciling?',
                    'How many doors require monthly owner statements?',
                    'What is your biggest financial or bookkeeping frustration today?',
                    'How up-to-date are your books right now?',
                    'How important is CFO-level support such as forecasting or budgeting?',
                    'Which finance deliverables matter most to you (P&Ls, forecasts, tax prep, etc.)?',
                    'If we built a Fractional Finance package for you, how many doors would you want supported immediately? (min. 71)',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'SocialMediaMarketing': {
                title: 'Social Media Marketing',
                questions: [
                    'Are you actively looking for social media support in the next 30-90 days, and if we secure strong bulk pricing, would you be ready to sign up right away?',
                    'Which social platforms are you currently using (with handles for each), and how often are you posting on your primary account right now?',
                    { q: 'What are your top goals for social media over the next 12 months (e.g. brand awareness/authority in your market, attracting homeowners/investors, recruiting, community building), and how important is brand presence vs directly trackable revenue/bookings?', type: 'textarea' },
                    'Do you already have a brand kit (logo, colors, fonts) and a library of good-quality photo/video content for your properties, team, and local area that a partner can work with?',
                    'How many properties do you manage, in which main markets/cities, and do you operate multiple brands that would need separate content strategies?',
                    'What level of support are you most interested in: strategy only, strategy + content creation, or full-service (content creation + posting + engagement/community management)?',
                    'Are you open to having you/your team on camera (talking-head/behind-the-scenes) or do you prefer mainly property and graphic-based content?',
                    'How would you describe your desired brand tone (e.g. luxury, playful, educational, corporate, edgy, down-to-earth), and how comfortable are you with trend-based/creative risk vs keeping things conservative?',
                    'What monthly budget range would you realistically allocate to social media marketing if it clearly supported your brand and homeowner/investor goals?',
                    'What would make this partnership feel like a clear "win" in the first 3-6 months (specific signals or outcomes you\'d like to see)?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'CanMonkey': {
                title: 'CanMonkey',
                questions: [
                    'How many of your properties have recurring trash or can-to-curb issues?',
                    'How do you currently handle trash for those properties?',
                    'How often do trash issues create extra trips or inconveniences for your team?',
                    'How often do trash problems cause guest complaints or fines?',
                    'Which cities or neighborhoods have the most frequent trash-related issues?',
                    'What do you currently spend per door per month on extra trips or fines related to trash?',
                    'How many doors would you enroll into a dedicated can-to-curb service?',
                    'Do you prefer ongoing weekly service or on-demand only?',
                    'How soon would you want to activate trash support if we secured a preferred rate?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'HRPayroll': {
                title: 'HR + Payroll or PEO',
                questions: [
                    'How many full-time employees do you have?',
                    'How many part-time employees do you have?',
                    'How many contractors or cleaners do you pay directly each month?',
                    'What payroll platform or HR system are you currently using?',
                    'What is your approximate monthly payroll cost?',
                    'Do you offer any employee benefits today?',
                    'Are you currently dealing with any compliance, HR, or payroll challenges?',
                    'Have you ever been fined or penalized for payroll or labor issues?',
                    'Do you feel confident that your current HR processes protect you legally?',
                    'Would you consider a PEO if the cost was similar to or lower than what you pay today?',
                    'How many employees would you enroll in a preferred-rate payroll or PEO solution?',
                    'When does your current payroll or HR contract end, if you have one?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'OutboundSales': {
                title: 'Outbound Homeowner Sales',
                questions: [
                    'Do you currently have anyone doing outbound homeowner acquisition for you?',
                    'How many new homeowners did you sign in the last 12 months?',
                    'How many new homeowners are you trying to sign in the next 12 months?',
                    'Which markets would you want outbound targeting in?',
                    'Would you prefer appointment setting only, or appointment setting plus lead management and follow-up?',
                    'Do you have operational capacity to onboard new doors quickly?',
                    'If we offered SDR support, how many new doors would you aim for per month?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'PortfolioAcquisitions': {
                title: 'Portfolio Acquisitions',
                questions: [
                    'Are you considering buying an STR property management portfolio in the next 12 to 24 months?',
                    'What size of portfolio would you ideally want to acquire?',
                    'What approximate purchase price range are you considering?',
                    'How much capital or equity could you deploy today?',
                    'What is the biggest blocker preventing you from acquiring a portfolio?',
                    'What support would be most valuable to you (deal sourcing, valuation, financing, due diligence, integration)?',
                    'If we provided discounted acquisition support, how soon would you be ready to pursue a deal?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'SuiteOp': {
                title: 'SuiteOp',
                questions: [
                    'How do you manage cleaning and turnovers today?',
                    'How many cleaners do you rely on across your portfolio?',
                    'What issues do you experience with cleaning coverage?',
                    'How often do you deal with missed or late turnovers?',
                    'How many of your properties need backup or on-demand cleaners?',
                    'How many doors would you enroll into a cleaning coverage or marketplace solution immediately?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'TopKey': {
                title: 'TopKey Financial Automation+Tracking',
                questions: [
                    'Are your bank feeds and financial accounts synced today?',
                    'What system do you currently use for financial tracking?',
                    'Where does your current financial workflow break down?',
                    'How accurate is your current transaction categorization?',
                    'How do you currently prepare owner statements?',
                    'How many doors would you plug into an automated financial system immediately?',
                    'Would you want standalone automation or automation plus bookkeeping?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'Conduit': {
                title: 'Conduit (AI Guest Messaging)',
                questions: [
                    'How do you currently handle guest messaging during the day?',
                    'How do you handle after-hours guest messaging?',
                    'What percentage of all guest messages are repetitive questions?',
                    'What percentage of guest issues require escalation to a human?',
                    'What PMS or inbox system do you use for messaging?',
                    'How many total guest messages do you receive per month?',
                    'How many of those occur after-hours or on weekends?',
                    'What are your biggest frustrations with your current guest messaging setup?', 
                    'Would you want AI to answer general questions only, or general plus troubleshooting?', 
                    'How many doors would you onboard into an AI-powered guest messaging system immediately?', 
                    'Do you want full 24/7 AI coverage or blended AI plus human support?', 
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'GuestSupport247': {
                title: '24/7 Guest Support',
                questions: [
                    'How do you currently handle guest messaging and support after hours?',
                    'What percentage of your guest messages occur outside normal business hours?',
                    'What is your approximate monthly message volume across your portfolio?',
                    'What type of support coverage do you need (full coverage, after-hours only, overflow)?',
                    'How much authority should a guest support agent have when responding?',
                    'How many doors would you place under a 24/7 guest support solution immediately?', 
                    'What is the most you would you pay per door per month for this service?'
                ]
            },
            'RevenueManagement': {
                title: 'Revenue Management',
                questions: [
                    'Who currently manages your pricing and revenue strategy?',
                    'Are you satisfied with your current ADR and occupancy levels?',
                    'What is your biggest challenge around revenue management?',
                    'What tools or people are you currently using for pricing?',
                    'How frequently do you update pricing?',
                    'How many doors would you move to a dedicated revenue management team today?',
                    'What level of performance improvement would motivate you to switch solutions?',
                    'What is the most you would you pay per door per month for this service?'
                ]
            }
        };

        // --- Firebase Globals ---
        let app, auth, db;
        
        // --- Core Application State ---
        let currentStepIndex = 0;
        let totalSteps = 0;
        const formState = {
            fullName: '',
            companyName: '',
            selectedServices: [],
            answers: {}, // Stores answers for dynamic steps
            submissionTime: null,
            uid: ''
        };

        const staticSteps = [
            {
                title: 'Step 1: Contact Information',
                id: 'step-contact',
                build: () => `
                    <div class="form-group">
                        <label for="fullName">Full Name <span style="color: var(--error-color);">*</span></label>
                        <input type="text" id="fullName" name="fullName" value="${formState.fullName}" required>
                    </div>
                    <div class="form-group">
                        <label for="companyName">Company Name <span style="color: var(--error-color);">*</span></label>
                        <input type="text" id="companyName" name="companyName" value="${formState.companyName}" required>
                    </div>
                `,
                validate: () => {
                    const fullName = document.getElementById('fullName').value.trim();
                    const companyName = document.getElementById('companyName').value.trim();
                    formState.fullName = fullName;
                    formState.companyName = companyName;
                    return fullName !== '' && companyName !== '';
                }
            },
            {
                title: 'Step 2: Preferred Service Selection',
                id: 'step-services',
                build: () => {
                    return `
                        <p style="margin-bottom: 25px; font-size: 1.1rem; color: #4a5568;">
                            Select all partnership areas you're interested in. Your answers will guide the next set of questions.
                        </p>
                        <div class="checkbox-group">
                            ${servicesList.map(service => `
                                <label class="checkbox-item">
                                    <input type="checkbox" name="service" value="${service.id}" ${formState.selectedServices.includes(service.id) ? 'checked' : ''}>
                                    <span>${service.label}</span>
                                </label>
                            `).join('')}
                        </div>
                    `;
                },
                validate: () => {
                    const selectedCheckboxes = Array.from(document.querySelectorAll('#step-services input[name="service"]:checked'));
                    formState.selectedServices = selectedCheckboxes.map(cb => cb.value);
                    return formState.selectedServices.length > 0;
                }
            }
        ];

        // --- Dynamic Step Functions ---

        /**
         * Generates the dynamic steps based on selected services.
         * The dynamic steps start at index 2.
         * @returns {Array<object>} The array of dynamic step objects.
         */
        function generateDynamicSteps() {
            return formState.selectedServices.map(serviceId => {
                const section = questionnaireSections[serviceId];
                if (!section) return null;

                return {
                    title: `${section.title} Details`,
                    id: `step-dynamic-${serviceId}`,
                    serviceId: serviceId,
                    build: () => {
                        let html = '';
                        section.questions.forEach((qObj, index) => {
                            const questionText = typeof qObj === 'string' ? qObj : qObj.q;
                            const inputType = typeof qObj === 'string' ? 'text' : qObj.type;
                            const inputId = `${serviceId}-q-${index}`;
                            
                            const savedAnswer = formState.answers[serviceId] && formState.answers[serviceId][index] ? formState.answers[serviceId][index].answer : '';

                            html += `
                                <div class="form-group">
                                    <label for="${inputId}">Q${index + 1}. ${questionText} <span style="color: var(--error-color);">*</span></label>
                                    ${inputType === 'textarea' ?
                                        `<textarea id="${inputId}" name="${inputId}" required>${savedAnswer}</textarea>` :
                                        `<input type="text" id="${inputId}" name="${inputId}" value="${savedAnswer}" required>`
                                    }
                                </div>
                            `;
                        });
                        return html;
                    },
                    validate: () => {
                        const answers = {};
                        const questions = section.questions;
                        let isValid = true;
                        
                        formState.answers[serviceId] = []; // Clear previous answers for this service

                        questions.forEach((qObj, index) => {
                            const questionText = typeof qObj === 'string' ? qObj : qObj.q;
                            const inputId = `${serviceId}-q-${index}`;
                            const inputElement = document.getElementById(inputId);
                            const answer = inputElement ? inputElement.value.trim() : '';

                            if (answer === '') {
                                isValid = false;
                            }
                            
                            formState.answers[serviceId].push({
                                question: questionText,
                                answer: answer
                            });
                        });
                        
                        return isValid;
                    }
                };
            }).filter(step => step !== null);
        }

        /**
         * Generates the final summary step.
         * @returns {object} The summary step object.
         */
        function getSummaryStep() {
            return {
                title: 'Final Step: Submission Summary',
                id: 'step-summary',
                build: () => {
                    let html = '<div id="summary-content">';

                    // 1. Contact Info Summary
                    html += `
                        <div class="summary-section">
                            <h3>Contact Information</h3>
                            <div class="summary-answer">
                                <span class="summary-question">Full Name:</span>
                                <span class="summary-value">${formState.fullName}</span>
                            </div>
                            <div class="summary-answer">
                                <span class="summary-question">Company Name:</span>
                                <span class="summary-value">${formState.companyName}</span>
                            </div>
                        </div>
                    `;

                    // 2. Services Summary
                    const selectedServiceLabels = servicesList
                        .filter(s => formState.selectedServices.includes(s.id))
                        .map(s => s.label);
                    
                    html += `
                        <div class="summary-section">
                            <h3>Selected Services</h3>
                            <div class="summary-answer">
                                <span class="summary-value">${selectedServiceLabels.join(', ')}</span>
                            </div>
                        </div>
                    `;

                    // 3. Dynamic Answers Summary
                    formState.selectedServices.forEach(serviceId => {
                        const sectionTitle = questionnaireSections[serviceId] ? questionnaireSections[serviceId].title : serviceId;
                        const answers = formState.answers[serviceId] || [];

                        html += `
                            <div class="summary-section">
                                <h3>${sectionTitle} Questions</h3>
                                ${answers.map(item => `
                                    <div class="summary-answer">
                                        <span class="summary-question">${item.question}</span>
                                        <span class="summary-value">${item.answer || 'N/A (No Answer Provided)'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    });

                    html += '</div><p style="margin-top: 25px; font-size: 1.1rem; font-weight: 500; color: #2d3748;">Please review your answers before submitting. We look forward to connecting!</p>';
                    return html;
                },
                validate: () => true // Summary step is always valid
            };
        }
        
        // --- Firebase Initialization ---
        // Initialize Firebase services immediately upon script execution
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setLogLevel('debug'); // For logging in console

        /**
         * Authenticates with Firebase using custom token or anonymously.
         */
        async function authenticateFirebase() {
            try {
                if (initialAuthToken && initialAuthToken.length > 50) { // Check for a realistically long token
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    console.log('Firebase authenticated with custom token.');
                    formState.uid = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    console.log('Firebase authenticated anonymously.');
                    formState.uid = userCredential.user.uid;
                }
            } catch (error) {
                console.error('Firebase Authentication Error:', error);
                // Fallback to anonymous if custom token fails
                try {
                     const userCredential = await signInAnonymously(auth);
                     console.log('Firebase authenticated anonymously (after fallback).');
                     formState.uid = userCredential.user.uid;
                } catch (anonError) {
                    console.error('Final Firebase Authentication Failure:', anonError);
                }
            }
        }
        
        /**
         * Submits the form data to Firestore using modular functions.
         */
        async function submitFormData() {
            const dataToSave = {
                appId: appId,
                uid: formState.uid,
                fullName: formState.fullName,
                companyName: formState.companyName,
                selectedServices: formState.selectedServices,
                answers: formState.answers,
                timestamp: serverTimestamp() // Using modular serverTimestamp
            };

            try {
                // Using modular addDoc and collection functions
                const docRef = await addDoc(collection(db, FIRESTORE_COLLECTION_PATH), dataToSave);
                console.log('Document successfully written with ID:', docRef.id);
                
                // Success: show modal and reset button
                document.getElementById('success-modal').style.display = 'flex';
                document.getElementById('next-btn').disabled = false;
                document.getElementById('next-btn').textContent = 'Confirm & Submit';

            } catch (error) {
                console.error('Error writing document:', error);
                // Error: show error message and reset button
                document.getElementById('validation-error').textContent = 'Submission failed due to a server error. Please try again. Check console for details.';
                document.getElementById('validation-error').style.display = 'block';
                document.getElementById('next-btn').disabled = false;
                document.getElementById('next-btn').textContent = 'Confirm & Submit';
            }
        }
        
        // --- UI & Step Management Functions ---
        
        /**
         * Get the full, sequenced list of steps based on current state.
         * @returns {Array<object>} All steps for the current form flow.
         */
        function getStepConfiguration() {
            const dynamicSteps = generateDynamicSteps();
            return [...staticSteps, ...dynamicSteps, getSummaryStep()];
        }

        /**
         * Renders the form based on the currentStepIndex.
         */
        function renderStep() {
            const steps = getStepConfiguration();
            totalSteps = steps.length;

            if (currentStepIndex < 0 || currentStepIndex >= totalSteps) {
                console.error('Invalid step index:', currentStepIndex);
                currentStepIndex = 0;
            }

            const currentStep = steps[currentStepIndex];
            const stepsContainer = document.getElementById('steps-container');
            const newStepContent = document.createElement('div');
            newStepContent.id = currentStep.id;
            newStepContent.className = 'step-content';
            newStepContent.innerHTML = `
                <h2>${currentStep.title}</h2>
                ${currentStep.build()}
            `;

            // Clear previous step content
            stepsContainer.innerHTML = '';
            stepsContainer.appendChild(newStepContent);
            
            // Apply animation after content is added
            setTimeout(() => {
                newStepContent.classList.add('active');
            }, 50);

            // 2. Update Progress Bar
            const progress = (currentStepIndex + 1) / totalSteps;
            document.getElementById('progress-fill').style.width = `${progress * 100}%`;
            document.getElementById('step-info').textContent = `Step ${currentStepIndex + 1} of ${totalSteps}`;

            // 3. Update Buttons
            const backBtn = document.getElementById('back-btn');
            const nextBtn = document.getElementById('next-btn');

            backBtn.style.display = currentStepIndex > 0 ? 'block' : 'none';
            nextBtn.disabled = false;
            nextBtn.textContent = (currentStepIndex === totalSteps - 1) ? 'Confirm & Submit' : 'Next Step →';

            document.getElementById('validation-error').style.display = 'none';
        }

        /**
         * Handles the "Back" button click.
         */
        function handleBack() {
            if (currentStepIndex > 0) {
                const steps = getStepConfiguration();
                // Validate current step to save input values before moving back
                steps[currentStepIndex].validate(); 
                
                currentStepIndex--;
                renderStep();
            }
        }

        /**
         * Handles the "Next" button click, including validation and submission.
         */
        function handleNext() {
            const steps = getStepConfiguration();
            const currentStep = steps[currentStepIndex];
            const errorElement = document.getElementById('validation-error');
            
            // 1. Validation
            const isValid = currentStep.validate();
            
            if (!isValid) {
                errorElement.textContent = `Please fill out all required fields in Step ${currentStepIndex + 1}: ${currentStep.title}.`;
                errorElement.style.display = 'block';
                return;
            }
            
            errorElement.style.display = 'none';

            // Special logic for Step 2: Recalculate steps for dynamic flow
            if (currentStep.id === 'step-services' && currentStepIndex < totalSteps - 1) {
                // If services change, we must update the total steps before checking navigation bounds
                const newSteps = getStepConfiguration();
                totalSteps = newSteps.length;
            }

            // 2. Navigation / Submission
            if (currentStepIndex < totalSteps - 1) {
                currentStepIndex++;
                renderStep();
            } else if (currentStepIndex === totalSteps - 1) {
                // Final Step: Submission
                const nextBtn = document.getElementById('next-btn');
                nextBtn.disabled = true;
                nextBtn.textContent = 'Submitting...';
                
                // *** FIX APPLIED HERE: Use a slight delay to ensure the UI updates before the async Firebase call starts ***
                setTimeout(() => {
                    submitFormData();
                }, 50);
            }
        }

        // --- Admin Panel Functions ---

        /**
         * Opens the Admin Panel and loads data.
         */
        async function openAdminPanel() {
            const panelModal = document.getElementById('admin-panel-modal');
            const tableBody = document.getElementById('submissions-table-body');
            const loadingMsg = document.getElementById('loading-submissions');
            const table = document.getElementById('submissions-table');
            const errorElement = document.getElementById('admin-load-error');
            
            errorElement.style.display = 'none';
            loadingMsg.style.display = 'block';
            table.style.display = 'none';
            tableBody.innerHTML = '';
            panelModal.style.display = 'flex';

            try {
                // Ensure Firebase is signed in, if not, signInAnonymously (should be handled on load)
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }

                // Using modular getDocs and collection functions
                const q = query(collection(db, FIRESTORE_COLLECTION_PATH));
                const querySnapshot = await getDocs(q);
                
                let submissions = [];
                querySnapshot.forEach(doc => {
                    submissions.push({ id: doc.id, ...doc.data() });
                });
                
                loadingMsg.style.display = 'none';

                if (submissions.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: #718096;">No submissions found yet.</td></tr>';
                    table.style.display = 'table';
                    return;
                }
                
                // Sorting is done client-side since orderBy is not guaranteed to work without indexes
                submissions.sort((a, b) => b.timestamp.toDate().getTime() - a.timestamp.toDate().getTime()); // Sort by newest first

                submissions.forEach(sub => {
                    const date = sub.timestamp.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const services = sub.selectedServices.map(id => servicesList.find(s => s.id === id)?.label.split(' ')[0] || id).join(', ');
                    
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = date;
                    row.insertCell(1).textContent = sub.companyName;
                    row.insertCell(2).textContent = sub.fullName;
                    row.insertCell(3).textContent = services;
                    
                    const actionCell = row.insertCell(4);
                    const viewButton = document.createElement('button');
                    viewButton.textContent = 'View Answers';
                    viewButton.className = 'primary-btn view-answers-btn';
                    viewButton.onclick = () => showSubmissionDetails(sub);
                    actionCell.appendChild(viewButton);
                });
                
                table.style.display = 'table';
                
            } catch (e) {
                console.error("Error fetching submissions:", e);
                loadingMsg.style.display = 'none';
                errorElement.textContent = 'Error loading submissions. Please check your internet connection or console for details.';
                errorElement.style.display = 'block';
            }
        }
        
        /**
         * Populates and shows the modal for a single submission's details.
         * @param {object} submissionData The data of the selected submission.
         */
        function showSubmissionDetails(submissionData) {
            const detailsDiv = document.getElementById('view-submission-details');
            detailsDiv.innerHTML = '';

            // 1. Contact Info
            detailsDiv.innerHTML += `
                <div class="summary-section">
                    <h3>Contact & Meta</h3>
                    <div class="summary-answer">
                        <span class="summary-question">Date:</span>
                        <span class="summary-value">${submissionData.timestamp.toDate().toLocaleString()}</span>
                    </div>
                    <div class="summary-answer">
                        <span class="summary-question">Full Name:</span>
                        <span class="summary-value">${submissionData.fullName}</span>
                    </div>
                    <div class="summary-answer">
                        <span class="summary-question">Company Name:</span>
                        <span class="summary-value">${submissionData.companyName}</span>
                    </div>
                </div>
            `;
            
            // 2. Services
            const selectedServiceLabels = servicesList
                .filter(s => submissionData.selectedServices.includes(s.id))
                .map(s => s.label);
            
            detailsDiv.innerHTML += `
                <div class="summary-section">
                    <h3>Selected Services</h3>
                    <div class="summary-answer">
                        <span class="summary-value">${selectedServiceLabels.join(', ')}</span>
                    </div>
                </div>
            `;

            // 3. Dynamic Answers
            submissionData.selectedServices.forEach(serviceId => {
                const sectionTitle = questionnaireSections[serviceId] ? questionnaireSections[serviceId].title : serviceId;
                const answers = submissionData.answers[serviceId] || [];

                detailsDiv.innerHTML += `
                    <div class="summary-section">
                        <h3>${sectionTitle} Answers</h3>
                        ${answers.map((item, index) => `
                            <div class="summary-answer">
                                <span class="summary-question">Q${index + 1}. ${item.question}</span>
                                <span class="summary-value">${item.answer || 'N/A'}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            });

            document.getElementById('view-submission-modal').style.display = 'flex';
        }
        
        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for authentication before rendering the form to ensure formState.uid is set
            authenticateFirebase().then(() => {
                renderStep(); 
            });

            document.getElementById('back-btn').addEventListener('click', handleBack);
            document.getElementById('next-btn').addEventListener('click', handleNext);

            // Admin Login setup
            const adminLoginModal = document.getElementById('admin-login-modal');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminPasswordInput = document.getElementById('admin-password');
            const adminLoginError = document.getElementById('admin-login-error');
            
            document.getElementById('admin-btn').addEventListener('click', () => {
                adminLoginModal.style.display = 'flex';
                adminPasswordInput.value = '';
                adminLoginError.style.display = 'none';
            });

            adminLoginBtn.addEventListener('click', () => {
                if (adminPasswordInput.value === ADMIN_PASSWORD) {
                    adminLoginModal.style.display = 'none';
                    openAdminPanel();
                } else {
                    adminLoginError.textContent = 'Invalid password.';
                    adminLoginError.style.display = 'block';
                }
            });
            
            // Close modals with the ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('success-modal').style.display = 'none';
                    document.getElementById('admin-login-modal').style.display = 'none';
                    document.getElementById('admin-panel-modal').style.display = 'none';
                    document.getElementById('view-submission-modal').style.display = 'none';
                }
            });
            
        });
    </script>

</body>
</html>
